<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CAD Gas v10.4 - Control Invertido</title>
<style>
    /* --- ESTILOS CORE --- */
    :root { --bg: #1e1e1e; --panel: #252526; --border: #333; --accent: #0078d7; --text: #ccc; --snap: #00ff00; }
    body { 
        font-family: 'Segoe UI', Consolas, sans-serif; background-color: var(--bg); color: var(--text);
        margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none;
    }
    
    /* HEADER */
    header { background-color: #2d2d2d; height: 45px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; padding: 0 15px; z-index: 100; }
    .brand { font-weight:700; color:#fff; margin-right:10px; font-size:1rem; letter-spacing:1px; }
    .brand span { color: var(--accent); }
    
    /* Botones Generales */
    button.btn, select.btn, input.btn-input { background: #3c3c3c; color: #eee; border: 1px solid #555; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 0.85rem; display:flex; align-items:center; gap:6px; transition:0.2s; outline:none; }
    button.btn:hover, select.btn:hover { background: #505050; border-color: #777; }
    button.primary { background: var(--accent); border-color: #005a9e; font-weight:600; }
    button.primary:hover { background: #1084e3; }
    button.danger { background: #822; border-color: #600; }
    
    /* Botones Activos (Header y Herramientas) */
    button.active, .tool-item.active { background: #444; border-color: var(--accent); color: #fff; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
    button.active { border: 1px solid var(--accent); }
    /* Separador Toolbar */
    .toolbar-sep { width: 1px; height: 24px; background: #555; margin: 0 5px; }
    
    /* DROPDOWN CAPAS */
    .layer-dropdown { position: relative; display: inline-block; }
    .layer-content { display: none; position: absolute; top: 35px; left: 0; background-color: var(--panel); min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); border: 1px solid var(--border); z-index: 200; border-radius: 4px; padding: 5px; }
    .layer-content.show { display: block; }
    .layer-row-header { display: flex; align-items: center; padding: 5px 10px; gap: 8px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
    .layer-row-header:hover { background: #333; }
    .layer-row-header.active { background: #37373d; border-left: 3px solid var(--accent); }
    
    /* WORKSPACE & PANELES */
    #workspace { flex-grow: 1; display: flex; position: relative; overflow: hidden; }
    
    #left-panel, #right-panel { 
        background-color: var(--panel); display: flex; flex-direction: column; z-index: 90; 
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
        overflow: hidden; white-space: nowrap; flex-shrink: 0; 
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    #left-panel { width: 240px; border-right: 1px solid var(--border); }
    #right-panel { width: 280px; border-left: 1px solid var(--border); }
    
    .closed { 
        width: 0 !important; min-width: 0 !important; border: none !important; opacity: 0;
        pointer-events: none;
    }
    /* PESTA√ëAS LATERALES */
    .panel-handle {
        position: absolute; top: 50%; transform: translateY(-50%);
        width: 20px; height: 60px;
        background: #2d2d2d; border: 1px solid #444; color: var(--accent);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 92; border-radius: 0 8px 8px 0;
        transition: 0.2s; font-size: 12px; box-shadow: 2px 0 5px rgba(0,0,0,0.3);
    }
    .panel-handle:hover { background: #444; width: 25px; color: #fff; }
    .handle-left { left: 0; }
    .handle-right { right: 0; border-radius: 8px 0 0 8px; border-left: 1px solid #444; border-right: none; }
    
    #left-panel:not(.closed) + .handle-left { left: 240px; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; margin-left: -10px; }
    #right-panel:not(.closed) ~ .handle-right { right: 280px; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; margin-right: -10px; }
    .panel-header { padding: 10px; background: #2d2d2d; font-weight:600; color:#fff; border-bottom:1px solid var(--border); display:flex; justify-content: space-between; align-items: center; }
    .lib-group { border-bottom: 1px solid var(--border); }
    .lib-group-title { padding: 8px 12px; cursor: pointer; font-size:0.8rem; font-weight:bold; color:#888; text-transform:uppercase; display:flex; justify-content:space-between; transition: 0.2s;}
    .lib-group-title:hover { color: #fff; background: #333; }
    .lib-items { display: none; padding: 5px; background: #1e1e1e; } 
    .lib-items.open { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .tool-item { display: flex; align-items: center; gap: 10px; padding: 6px 10px; margin: 2px 0; cursor: pointer; border-radius: 4px; transition: 0.1s; border: 1px solid transparent; }
    .tool-item:hover { background: #383838; } 
    .tool-item.active { background: #37373d; border-color: var(--accent); box-shadow: inset 3px 0 0 var(--accent); }
    .tool-icon { width: 20px; text-align: center; font-size: 1.1rem; } .tool-name { font-size: 0.85rem; }
    
    #main-area { flex-grow: 1; position: relative; background: #111; cursor: crosshair; }
    svg { display: block; width: 100%; height: 100%; }
    
    #cmd-panel { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(40, 40, 40, 0.9); border: 1px solid #555; padding: 5px; border-radius: 6px; display: flex; gap: 5px; backdrop-filter: blur(5px); z-index: 95; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .cmd-divider { width: 1px; background: #555; margin: 0 5px; }
    
    /* GUIZMO & GRID */
    #gizmo-container { position: absolute; bottom: 20px; left: 20px; width: 80px; height: 80px; pointer-events: none; z-index: 95; }
    .axis-line { stroke-width: 2; marker-end: url(#arrow); stroke-linecap: round; } .axis-text { font-family: monospace; font-weight: bold; font-size: 10px; }
    .grid-path, .grid-axis, .grid-minor { fill: none; pointer-events: none; }
    .grid-path { stroke: #2a2a2a; stroke-width: 1; vector-effect: non-scaling-stroke; }
    .grid-minor { stroke: #222; stroke-width: 0.5; vector-effect: non-scaling-stroke; opacity: 0.6; } 
    .grid-axis { stroke: #333; stroke-width: 2; vector-effect: non-scaling-stroke; }
    #capa-interfaz, #capa-referencias, #capa-hover { pointer-events: none; }
    
    /* ELEMENTOS */
    .tuberia { 
        fill: none; 
        stroke-linecap: round; 
        stroke-linejoin: round; 
        shape-rendering: geometricPrecision;
        transition: stroke 0.1s;
    } 
    .fitting-auto { fill: none; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; }
    
    .dim-line { stroke: #aaa; stroke-width: 1; vector-effect: non-scaling-stroke; pointer-events: none; }
    .dim-text { fill: #aaa; font-size: 12px; text-anchor: middle; font-family: monospace; pointer-events: none; }
    
    .label-tech { fill: #777; font-size: 9px; font-family: 'Segoe UI', sans-serif; pointer-events: none; text-anchor: middle; text-shadow: 1px 1px 2px #000; font-weight: 500; }
    .z-ref-line { stroke: #666; stroke-dasharray: 2,2; vector-effect: non-scaling-stroke; }
    .cursor-crosshair { stroke: #fff; stroke-width: 1; vector-effect: non-scaling-stroke; opacity: 0.9; }
    .snap-marker { fill: none; stroke: var(--snap); stroke-width: 2; vector-effect: non-scaling-stroke; filter: drop-shadow(0 0 2px var(--snap)); }
    .hover-halo { stroke: #fff; stroke-width: 6; opacity: 0.3; fill: none; pointer-events: none; stroke-linecap: round; }
    .sel-halo { stroke: var(--accent); stroke-width: 4; opacity: 0.8; fill: none; pointer-events: none; stroke-linecap: round; }
    
    /* PROPIEDADES */
    .sub-panel { display: flex; flex-direction: column; height: 100%;}
    .sp-top { flex: 1; overflow-y:auto; } 
    .prop-section-title { font-size: 0.7rem; font-weight: bold; color: var(--accent); margin: 15px 15px 5px 15px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 2px;}
    .prop-row { margin: 8px 15px; display: flex; flex-direction: column; gap: 4px; }
    .prop-row label { color: #aaa; font-size: 0.75rem; }
    .prop-row input[type="text"], .prop-row input[type="number"], .prop-row select { width: 100%; background: #181818; border: 1px solid #444; color: #eee; padding: 6px; border-radius: 3px; font-size: 0.85rem; box-sizing: border-box; }
    .prop-row input[type="color"] { width: 100%; height: 30px; border: 1px solid #444; background: #181818; padding: 2px; cursor: pointer; }
    
    /* HUD EDITABLE */
    .hud-overlay { 
        position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); 
        padding: 5px 10px; border-radius: 4px; color: #0ff; font-family: monospace; 
        display: flex; align-items: center; gap: 8px; backdrop-filter: blur(2px);
    }
    .hud-input { width: 40px; background: transparent; border: none; border-bottom: 1px solid #555; color: #0ff; font-family: monospace; font-size: 1em; text-align: center; outline: none; }
    .hud-input:focus { border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:200; justify-content:center; align-items:center; }
    .modal-box { background: var(--panel); padding:20px; border:1px solid #555; width:500px; border-radius:5px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    /* INPUT DIN√ÅMICO */
    #dynamic-input-container { position: absolute; background: rgba(37, 37, 38, 0.95); border: 1px solid var(--accent); padding: 5px 8px; border-radius: 4px; display: none; align-items: center; gap: 5px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    #dynamic-len { width: 70px; background: #111; border: 1px solid #444; color: #fff; padding: 2px 5px; border-radius: 2px; outline: none; font-family: monospace; }
    #dynamic-len:focus { border-color: var(--accent); }
</style>
</head>
<body>

<header>
    <div class="brand"><span>CAD</span> GAS v10.4</div>
    <button class="btn" onclick="guardarProyecto()">üíæ Guardar</button>
    <button class="btn" onclick="document.getElementById('file-input').click()">üìÇ Abrir</button>
    <button class="btn danger" onclick="limpiarTodo()">üóëÔ∏è Nuevo</button>
    <input type="file" id="file-input" style="display:none" onchange="cargarProyecto(this)">
    
    <div class="toolbar-sep"></div>
    <button id="btn-select" class="btn active" onclick="setTool('select')">üëÜ Seleccionar</button>
    <button id="btn-cota" class="btn" onclick="setTool('cota')">üìè Cota</button>
    <button id="btn-texto" class="btn" onclick="setTool('texto')">T Texto</button>
    <div class="toolbar-sep"></div>
    
    <div class="layer-dropdown">
        <button class="btn" onclick="toggleLayerMenu()">üìö Capas ‚ñº</button>
        <div id="layer-menu-content" class="layer-content">
            <div id="lista-capas-header"></div>
            <div style="padding:5px; border-top:1px solid #444;">
                <button class="btn" style="width:100%" onclick="addLayer()">+ Nueva Capa</button>
            </div>
        </div>
    </div>

    <button id="btn-toggle-tags" class="btn active" onclick="toggleTags()">üè∑Ô∏è Etiquetas</button>

    <div class="toolbar-sep"></div>
    
    <select class="btn" onchange="setUnit(this.value)">
        <option value="m">Metros (m)</option>
        <option value="dm">Cent√≠metros (cm)</option> <option value="mm">Mil√≠metros (mm)</option>
    </select>
    
    <div class="toolbar-sep"></div>
    <button class="btn" onclick="mostrarReporte()">üìã Reporte</button>
    <div id="msg-guardado" style="display:none; color:#0f0; font-size:0.8rem; margin-left:10px;">Guardado OK</div>
</header>

<div id="workspace">
    <div id="left-panel">
        <div class="panel-header">
            <span>Biblioteca</span>
            <span style="font-size:0.8rem; cursor:pointer;" onclick="togglePanel('left-panel')">‚úï</span>
        </div>
        
        <div class="lib-group">
            <div class="lib-group-title" onclick="toggleGroup('grp-mat')">
                Materiales <span>‚ñº</span>
            </div>
            <div class="lib-items open" id="grp-mat"></div> 
        </div>
        
        <div class="lib-group">
            <div class="lib-group-title" onclick="toggleGroup('grp-eq')">
                Equipos <span>‚ñº</span>
            </div>
            <div class="lib-items" id="grp-eq"></div>
        </div>
        
        <div class="lib-group">
            <div class="lib-group-title" onclick="toggleGroup('grp-inst')">
                Instrumentos <span>‚ñº</span>
            </div>
            <div class="lib-items" id="grp-inst"></div>
        </div>
        
        <div class="lib-group">
            <div class="lib-group-title" onclick="toggleGroup('grp-perif')">
                Perif√©ricos <span>‚ñº</span>
            </div>
            <div class="lib-items" id="grp-perif"></div>
        </div>
    </div>
    <div class="panel-handle handle-left" onclick="togglePanel('left-panel')">üõ†Ô∏è</div>
    
    <div id="main-area">
        <div id="cmd-panel">
            <button id="cmd-grid" class="btn active" onclick="toggleConfig('grid')" style="padding:4px 8px;">Grid ‚ñ¶</button>
            <button id="cmd-snap" class="btn active" onclick="toggleConfig('snap')" style="padding:4px 8px;">Snap üß≤</button>
            <div class="cmd-divider"></div>
            <button class="btn" onclick="resetView()" style="padding:4px 8px;">Centrar üéØ</button>
        </div>
        
        <svg id="lienzo-cad">
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#f00" />
                </marker>
            </defs>
            <g id="world-transform">
                <g id="grid-layer">
                    <path id="grid-minor" class="grid-minor"></path>
                    <path id="grid-path" class="grid-path"></path>
                    <path id="grid-axis" class="grid-axis"></path>
                </g>
                <g id="capa-referencias"></g>
                <g id="contenedor-elementos"></g>
                <g id="capa-fittings"></g>
                <g id="capa-seleccion"></g>
                <g id="capa-hover"></g>
                <g id="capa-interfaz"></g>
            </g>
        </svg>
        
        <div id="gizmo-container">
            <svg id="gizmo-svg" viewBox="0 0 100 100">
                <g id="gizmo-axes" transform="translate(50,50)"></g>
            </svg>
        </div>

        <div class="hud-overlay">
            <span>Zoom: <input type="number" id="hud-scale-input" class="hud-input" value="100" onchange="updateZoomInput(this.value)">%</span>
            <span>| Rot: <input type="number" id="hud-rot-input" class="hud-input" value="45" onchange="updateRotInput(this.value)">¬∞</span>
        </div>
        
        <div id="dynamic-input-container">
            <span>L:</span>
            <input type="text" id="dynamic-len">
            <span style="color:#0f0">‚úî</span>
        </div>
    </div>
    
    <div id="right-panel" class="closed">
        <div class="panel-header">
            <span>Propiedades</span>
            <span style="font-size:0.8rem; cursor:pointer;" onclick="togglePanel('right-panel')">‚úï</span>
        </div>
        <div class="sub-panel">
            <div id="prop-vacio" style="padding:20px; color:#666; text-align:center; font-size:0.85rem;">
                Seleccione un objeto para ver sus propiedades
            </div>
            
            <div id="prop-form" class="sp-top" style="display:none;">
                <div class="prop-section-title">Informaci√≥n</div>
                <div class="prop-row">
                    <label>Tag (Etiqueta)</label>
                    <input type="text" id="p-tag" onchange="updateStyleProp('tag', this.value)">
                </div>
                <div class="prop-row">
                    <label>Capa Actual</label>
                    <select id="p-capa" class="btn" onchange="updateStyleProp('layerId', this.value)"></select>
                </div>
                
                <div class="prop-row" id="row-longitud">
                      <label>Longitud (<span id="lbl-unit">m</span>)</label>
                      <input type="text" inputmode="decimal" id="p-longitud" onchange="updateLongitud(this.value)">
                </div>
                
                <div id="prop-datos-tecnicos"></div>
                
                <div class="prop-section-title">Apariencia</div>
                <div class="prop-row">
                    <label>Color</label>
                    <input type="color" id="p-color" onchange="updateStyleProp('color', this.value)">
                </div>
                
                <div class="prop-row">
                    <label>Tipo de L√≠nea</label>
                    <select id="p-linestyle" class="btn" onchange="updateStyleProp('tipoLinea', this.value)">
                        <option value="solid">S√≥lida (‚éØ‚éØ‚éØ)</option>
                        <option value="dashed">Guiones (- - -)</option>
                        <option value="dotted">Punteada (¬∑ ¬∑ ¬∑)</option>
                    </select>
                </div>
                
                <div class="prop-row" id="row-grosor">
                    <label>Grosor Visual</label>
                    <input type="number" id="p-grosor" value="2" onchange="updateStyleProp('grosor', this.value)">
                </div>
                
                <div class="prop-row">
                      <label>Rotaci√≥n Objeto (¬∞)</label>
                      <input type="number" id="p-rot" onchange="updateStyleProp('rotacion', this.value)">
                </div>
                <div class="prop-row" style="margin-top:15px;">
                    <button class="btn danger" onclick="borrarSeleccion()" style="justify-content:center;">Eliminar Objeto</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="panel-handle handle-right" onclick="togglePanel('right-panel')">‚öôÔ∏è</div>

<div id="modal-reporte" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h3>Listado de Materiales</h3>
        <table id="tabla-res" style="width:100%; font-size:0.9rem; border-collapse: collapse; color:#ccc;"></table>
        <br>
        <button class="btn" onclick="document.getElementById('modal-reporte').style.display='none'" style="float:right;">Cerrar</button>
    </div>
</div>

<div id="modal-guardar" class="modal">
    <div class="modal-box">
        <h3>Guardar Proyecto</h3>
        <div style="margin-bottom:15px;">Nombre:</div>
        <input type="text" id="input-filename" class="btn-input" value="proyecto_gas" style="width:100%; margin-bottom:15px;">
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn" onclick="guardarEnNavegador()">‚ö° Navegador</button>
            <button class="btn primary" onclick="confirmarDescarga()">üíæ Descargar JSON</button>
            <button class="btn" onclick="document.getElementById('modal-guardar').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<script>
// --- HELPER PARA INPUTS CON COMA ---
function parseInputFloat(val) {
    if (typeof val === 'number') return val;
    if (!val) return 0;
    // Reemplaza coma por punto y parsea
    return parseFloat(val.toString().replace(',', '.'));
}

// --- LISTAS DE DIAMETROS DISPONIBLES ---
const DIAMETROS_DISPONIBLES = {
    'acero': ['1/4"', '1/2"', '3/4"', '1"', '1-1/4"', '1-1/2"', '2"', '2-1/2"', '3"', '4"'],
    'pe': ['20mm', '25mm', '32mm', '40mm', '50mm', '63mm', '90mm'],
    'cobre': ['3/8"', '1/2"', '5/8"', '3/4"', '1"']
};

// --- CONFIGURACI√ìN CON CORRECCI√ìN DE ESCALA ---
let CONFIG = { 
    // tileW cambiado de 40 a 100. Ahora 1 metro = 100 pixeles.
    tileW: 100, 
    tileH: 50, // Ajustado para mantener proporci√≥n isom√©trica 2:1
    zStep: 1, 
    // AJUSTE CLAVE: Reducido de 20 a 8 para permitir selecci√≥n precisa en objetos peque√±os (ej. 10cm)
    snapRadius: 8, 
    showGrid: true, enableSnap: true, unit: 'm',
    showTags: true 
};
const UNITS = { 'm': { factor: 1, label: 'm', precision: 2 }, 'dm': { factor: 10, label: 'dm', precision: 1 }, 'cm': { factor: 100, label: 'cm', precision: 1 }, 'mm': { factor: 1000, label: 'mm', precision: 0 } };

// --- NUEVA L√ìGICA DE ESCALA REALISTA ---
function parseDiameterToScale(valStr) {
    if(!valStr) return 2; 

    let meters = 0;
    // 1. Limpieza y Parseo a Metros
    if(valStr.toLowerCase().includes('mm')) {
        meters = parseFloat(valStr) / 1000;
    } else {
        let clean = valStr.replace(/"/g, '').trim();
        let parts = clean.split(/[- ]/);
        let inches = 0;
        parts.forEach(p => {
            if(p.includes('/')) {
                const frac = p.split('/');
                if(frac.length === 2) inches += parseFloat(frac[0]) / parseFloat(frac[1]);
            } else {
                inches += parseFloat(p);
            }
        });
        meters = inches * 0.0254;
    }

    if(isNaN(meters) || meters === 0) return 2;

    // 2. Convertir Metros a P√≠xeles de Pantalla (World Units)
    let pixelWidth = meters * CONFIG.tileW;

    // 3. Forzar un m√≠nimo visible mejorado. Si es muy fino, se dibuja al menos de 2px
    return Math.max(1.5, pixelWidth);
}

// --- CATALOGO ACTUALIZADO ---
const CATALOGO = {
    mat: [
        { id: 't_acero', name: 'Acero Sch40', color: '#FFD700', type: 'tuberia', props: { material: 'acero', diametroNominal: '1"' } },
        { id: 't_pe', name: 'Polietileno (PE)', color: '#E6E600', type: 'tuberia', props: { material: 'pe', diametroNominal: '32mm' } },
        { id: 't_cobre', name: 'Cobre Tipo L', color: '#ff8c00', type: 'tuberia', props: { material: 'cobre', diametroNominal: '1/2"' } }
    ],
    eq: [
        { id: 'eq_medidor', name: 'Medidor G4', icon: '‚è±Ô∏è', type: 'equipo', props: { modelo: 'G4' } },
        { id: 'eq_reg', name: 'Regulador', icon: '‚öôÔ∏è', type: 'equipo', props: { cap: '5 m3/h' } }
    ],
    inst: [
         { id: 'i_mano', name: 'Man√≥metro', icon: '‚åö', type: 'equipo', props: { rango: '0-60 psi' } }
    ],
    perif: [
        { id: 'v_bola', name: 'V√°lvula Bola', icon: '‚ßì', type: 'valvula', props: { tipo: 'bola', rotacion: 0 } },
        { id: 'v_check', name: 'V√°lvula Check', icon: '‚ñ∂', type: 'valvula', props: { tipo: 'retencion', rotacion: 0 } }
    ]
};
let layers = [{ id: 'l_gas', name: 'Gas', color: '#FFD700', visible: true }];
let activeLayerId = 'l_gas';
let elementos = [];

let estado = {
    tool: 'select', activeItem: null, mouseIso: {x:0, y:0}, snapped: null, currentZ: 0,
    drawing: false, startPt: null, selID: null, hoverID: null,
    view: { x: 0, y: 0, scale: 1, angle: Math.PI/4 },
    action: null, startAction: {x:0, y:0}, snapDir: null, tempVector: null 
};
const svg = document.getElementById('lienzo-cad');
const world = document.getElementById('world-transform');

function setUnit(u) { CONFIG.unit = u; renderScene(); renderInterface(); updatePropsPanel(); }
function formatLength(valMeters) { const u = UNITS[CONFIG.unit]; const val = valMeters * u.factor; return parseFloat(val.toFixed(u.precision)) + " " + u.label; }
function parseToMeters(valUser) { const u = UNITS[CONFIG.unit]; return valUser / u.factor; }

// --- MATH 3D ---
function isoToScreen(x, y, z) {
    const ang = estado.view.angle;
    const nx = x * Math.cos(ang) - y * Math.sin(ang);
    const ny = x * Math.sin(ang) + y * Math.cos(ang);
    // Usamos CONFIG.tileW para la escala base
    return { x: nx * CONFIG.tileW, y: ny * CONFIG.tileH - (z * CONFIG.tileW * 0.7) };
}
function screenToIso(sx, sy) {
    const ang = estado.view.angle;
    const nx = sx / CONFIG.tileW;
    const ny = sy / CONFIG.tileH;
    const x = nx * Math.cos(-ang) - ny * Math.sin(-ang);
    const y = nx * Math.sin(-ang) + ny * Math.cos(-ang);
    return { x: x, y: y }; 
}
function getSVGPoint(ex, ey) { const pt = svg.createSVGPoint(); pt.x = ex; pt.y = ey; return pt.matrixTransform(world.getScreenCTM().inverse()); }

function updateTransform() {
    world.setAttribute('transform', `translate(${estado.view.x}, ${estado.view.y}) scale(${estado.view.scale})`);
    document.getElementById('hud-scale-input').value = Math.round(estado.view.scale*100);
    document.getElementById('hud-rot-input').value = Math.round(estado.view.angle * 180/Math.PI);
    renderGizmo();
}
function updateZoomInput(val) {
    let v = parseInputFloat(val); if(isNaN(v) || v < 10) v = 10; if(v > 2000) v = 2000;
    estado.view.scale = v / 100; updateTransform(); renderEffects();
}
function updateRotInput(val) {
    let v = parseInputFloat(val); if(!isNaN(v)) { estado.view.angle = v * Math.PI / 180; updateTransform(); renderGrid(); renderScene(); renderEffects(); }
}
// --- ANALIZADOR DE RED ---
function analizarRed() {
    const nodos = {}; 
    elementos.forEach(el => {
        if (el.tipo === 'tuberia') {
            const k1 = `${el.x.toFixed(3)},${el.y.toFixed(3)},${el.z.toFixed(3)}`; 
            const k2 = `${(el.x + el.dx).toFixed(3)},${(el.y + el.dy).toFixed(3)},${(el.z + el.dz).toFixed(3)}`;
            const len = Math.sqrt(el.dx**2 + el.dy**2 + el.dz**2);
            if(len < 0.001) return;
            const dir = { x: el.dx/len, y: el.dy/len, z: el.dz/len }; const dirInv = { x: -dir.x, y: -dir.y, z: -dir.z };
            let width = 2; if(el.props.diametroNominal) width = parseDiameterToScale(el.props.diametroNominal);
            const data = { id: el.id, color: el.props.customColor || el.props.color || '#ccc', width: width };
            if(!nodos[k1]) nodos[k1] = []; nodos[k1].push({ dir: dir, ...data });
            if(!nodos[k2]) nodos[k2] = []; nodos[k2].push({ dir: dirInv, ...data });
        }
    });
    const accesorios = [];
    Object.keys(nodos).forEach(k => {
        const conns = nodos[k]; const coords = k.split(',').map(Number);
        const x=coords[0], y=coords[1], z=coords[2];
        const color = conns[0].color; const width = conns[0].width;
        if (conns.length === 2) {
            const v1 = conns[0].dir; const v2 = conns[1].dir;
            if (Math.abs(v1.x*v2.x + v1.y*v2.y + v1.z*v2.z) < 0.1) accesorios.push({ tipo: 'codo_auto', x, y, z, dirs: [v1, v2], color, width });
        }
        else if (conns.length === 3) accesorios.push({ tipo: 'tee_auto', x, y, z, dirs: conns.map(c=>c.dir), color, width });
        else if (conns.length === 4) accesorios.push({ tipo: 'cruz_auto', x, y, z, dirs: conns.map(c=>c.dir), color, width });
    });
    return accesorios;
}

// --- RENDERIZADO MEJORADO ---
function renderGrid() {
    const pMaj = document.getElementById('grid-path'); const pMin = document.getElementById('grid-minor'); const a = document.getElementById('grid-axis');
    if(!CONFIG.showGrid) { pMaj.setAttribute('d', ''); pMin.setAttribute('d', ''); a.setAttribute('d', ''); return; }
    let dMaj="", dMin="", da=""; const sz=20; const step = 1; // Grid de 1 metro
    for(let i=-sz; i<=sz; i+=step) {
        let p1=isoToScreen(-sz,i,0), p2=isoToScreen(sz,i,0); let seg = `M${p1.x},${p1.y} L${p2.x},${p2.y} `;
        if(i===0) da+=seg; else if(i%5 === 0) dMaj+=seg; else dMin+=seg; 
    }
    for(let i=-sz; i<=sz; i+=step) {
        let p1=isoToScreen(i,-sz,0), p2=isoToScreen(i,sz,0); let seg = `M${p1.x},${p1.y} L${p2.x},${p2.y} `;
        if(i===0) da+=seg; else if(i%5 === 0) dMaj+=seg; else dMin+=seg;
    }
    pMaj.setAttribute('d
